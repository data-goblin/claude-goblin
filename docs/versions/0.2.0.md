# Version 0.2.0 - Cross-Device Sync Support

Released: December 2025

## Overview

Major release adding cross-device synchronization support. Users can now sync their usage data across multiple devices using various providers: Syncthing (P2P), OneDrive, OneLake (Microsoft Fabric), or MotherDuck (DuckDB cloud).

## New Features

### Cross-Device Sync Commands

New `ccg sync` command group for configuring multi-device synchronization:

```bash
ccg sync setup     # Interactive setup wizard
ccg sync status    # Show current sync configuration
ccg sync add-device <device-id>  # Add Syncthing peer (Syncthing only)
```

### Storage Format Selection

Choose between SQLite (default) or DuckDB for analytics-heavy workloads:

```bash
ccg sync setup --storage sqlite   # Lightweight, battle-tested
ccg sync setup --storage duckdb   # Analytical queries, MotherDuck support
```

### Sync Providers

Four sync providers available:

| Provider | Storage | Description |
|----------|---------|-------------|
| Syncthing | Both | P2P sync, no cloud, free |
| OneDrive | Both | Local folder sync via OneDrive app |
| OneLake | Both | Microsoft Fabric lakehouse |
| MotherDuck | DuckDB only | Native DuckDB cloud service |

### Non-Interactive Mode

All setup options available via flags for scripting:

```bash
# Full non-interactive setup
ccg sync setup \
  --storage sqlite \
  --provider syncthing \
  --device-id mac-work \
  --device-name "Work Laptop" \
  --yes

# OneLake setup
ccg sync setup \
  --storage sqlite \
  --provider onelake \
  --workspace "Analytics" \
  --lakehouse "Usage" \
  --yes

# MotherDuck setup (requires DuckDB)
ccg sync setup \
  --storage duckdb \
  --provider motherduck \
  --token "md_xxx" \
  --yes
```

### Per-Device Database Files

When sync is configured, each device gets its own database file:
- SQLite: `~/.claude/usage/{device_id}.db`
- DuckDB: `~/.claude/usage/{device_id}.duckdb`

This prevents write conflicts with file-based sync providers.

### Device Metadata Tracking

All records now include device information for cross-device aggregation:
- `device_id`: Unique device identifier
- `device_name`: Human-readable name
- `device_type`: Platform (macos, windows, linux)

### Database Migration

Automatic migration when switching storage formats or adding device metadata:

```python
from src.storage.migration import (
    migrate_sqlite_to_duckdb,
    migrate_duckdb_to_sqlite,
    migrate_sqlite_add_device_columns,
)
```

## Optional Dependencies

Install sync-related dependencies as needed:

```bash
# DuckDB support
uv pip install claude-goblin[duckdb]

# OneLake support (Azure SDK)
uv pip install claude-goblin[onelake]

# All sync features
uv pip install claude-goblin[sync]
```

## Technical Changes

### New Files

- `src/commands/sync/__init__.py` - Sync command group
- `src/commands/sync/setup.py` - Setup wizard
- `src/commands/sync/status.py` - Status display
- `src/commands/sync/add_device.py` - Syncthing device management
- `src/sync/__init__.py` - Sync module with provider factory
- `src/sync/providers/base.py` - Abstract provider interface
- `src/sync/providers/syncthing.py` - Syncthing provider
- `src/sync/providers/onedrive.py` - OneDrive provider
- `src/sync/providers/onelake.py` - OneLake/Fabric provider
- `src/sync/providers/motherduck.py` - MotherDuck provider
- `src/storage/duckdb_backend.py` - DuckDB storage backend
- `src/storage/migration.py` - Database migration utilities

### Modified Files

- `src/cli.py` - Added sync command group
- `src/config/user_config.py` - Added sync configuration keys
- `src/storage/__init__.py` - Added `get_db_path()` and backend selection
- `src/storage/snapshot_db.py` - Added device metadata columns
- `pyproject.toml` - Added optional dependencies

### Database Schema Changes

New columns added to all tables:
- `device_id TEXT`
- `device_name TEXT`
- `device_type TEXT`

Existing databases are automatically migrated when initialized.

## Upgrading

```bash
uv pip install --upgrade claude-goblin

# Or with sync features
uv pip install --upgrade "claude-goblin[sync]"
```

After upgrading, run `ccg sync setup` to configure device information.

## Compatibility Notes

- Existing SQLite databases are automatically migrated to add device columns
- Legacy `usage_history.db` path still works if no device_id is configured
- DuckDB storage requires explicit installation of duckdb package
- MotherDuck requires DuckDB storage format (not compatible with SQLite)
